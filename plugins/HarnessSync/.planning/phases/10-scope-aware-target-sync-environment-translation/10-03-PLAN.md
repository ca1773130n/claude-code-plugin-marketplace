---
phase: 10-scope-aware-target-sync-environment-translation
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - verify_phase10_integration.py
autonomous: true
verification_level: proxy

must_haves:
  truths:
    - "Integration test creates 2 user-scope MCPs (1 with ${API_KEY}, 1 with ${PORT:-3000}), 1 project-scope MCP, and 1 plugin MCP"
    - "Codex output: user config has 3 servers (2 user + 1 plugin), project config has 1 server, SSE server skipped"
    - "Gemini output: user config has 3 servers (2 user + 1 plugin), project config has 1 server"
    - "Codex user config has resolved env vars (literal values, not ${VAR} syntax)"
    - "Gemini user config preserves ${VAR} syntax unchanged"
    - "All warnings for undefined env vars and unsupported transports are captured"
  artifacts:
    - path: "verify_phase10_integration.py"
      provides: "Full integration test matching Success Criteria #8"
      min_lines: 50
  key_links:
    - from: "verify_phase10_integration.py"
      to: "src/adapters/codex.py"
      via: "CodexAdapter.sync_mcp_scoped()"
      pattern: "CodexAdapter"
    - from: "verify_phase10_integration.py"
      to: "src/adapters/gemini.py"
      via: "GeminiAdapter.sync_mcp_scoped()"
      pattern: "GeminiAdapter"
---

<objective>
Create and run a full integration test matching Phase 10 Success Criteria #8: verify all targets receive correct scoped configs with proper env var handling.

Purpose: Validate that the complete pipeline (scoped MCPs -> adapter scope routing -> env var translation -> transport validation -> file output) works end-to-end for all target CLIs.

Output: `verify_phase10_integration.py` that exercises all 7 requirements (SYNC-01..04, ENV-01..03) in a single test.
</objective>

<execution_context>
@${CLAUDE_PLUGIN_ROOT}/references/execute-plan.md
@${CLAUDE_PLUGIN_ROOT}/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-scope-aware-target-sync-environment-translation/10-01-SUMMARY.md
@.planning/phases/10-scope-aware-target-sync-environment-translation/10-02-SUMMARY.md

# Source files
@src/adapters/codex.py
@src/adapters/gemini.py
@src/adapters/opencode.py
@src/utils/env_translator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create and run Phase 10 integration test</name>
  <files>verify_phase10_integration.py</files>
  <action>
    Create `verify_phase10_integration.py` at project root with the following test scenario:

    **Test Setup:**
    ```python
    import os, json, tempfile, sys
    from pathlib import Path

    # Set test env vars
    os.environ["TEST_API_KEY"] = "sk-test-integration-key"
    os.environ.pop("UNDEFINED_PORT", None)  # Ensure unset for ${UNDEFINED_PORT:-3000} test
    ```

    **Test Data (matching Success Criteria #8):**
    ```python
    scoped_mcps = {
        # User-scope MCP with ${API_KEY} (ENV-01)
        "api-server": {
            "config": {
                "command": "npx",
                "args": ["-y", "@api/mcp-server", "--key", "${TEST_API_KEY}"],
                "env": {"NODE_ENV": "production"}
            },
            "metadata": {"scope": "user", "source": "file"}
        },
        # User-scope MCP with ${PORT:-3000} (ENV-02)
        "port-server": {
            "config": {
                "command": "node",
                "args": ["server.js", "--port", "${UNDEFINED_PORT:-3000}"]
            },
            "metadata": {"scope": "user", "source": "file"}
        },
        # Project-scope MCP (SYNC-01, SYNC-02)
        "project-db": {
            "config": {
                "command": "python",
                "args": ["-m", "db_server", "--local"]
            },
            "metadata": {"scope": "project", "source": "file"}
        },
        # Plugin MCP - must go to user scope (SYNC-03)
        "plugin-tools": {
            "config": {
                "command": "node",
                "args": ["/path/to/plugin/tools-server.js"]
            },
            "metadata": {
                "scope": "user",
                "source": "plugin",
                "plugin_name": "test-tools",
                "plugin_version": "2.1.0"
            }
        },
        # SSE server - should be skipped on Codex (SYNC-04)
        "sse-analytics": {
            "config": {
                "url": "https://analytics.example.com/mcp/sse"
            },
            "metadata": {"scope": "user", "source": "file"}
        }
    }
    ```

    **Verification Checks (organized by requirement):**

    For each adapter (Codex, Gemini), create a temporary directory structure, run sync_mcp_scoped(), then verify:

    **SYNC-01 (Gemini scope routing):**
    - User-scope servers written to `{tmpdir}/home/.gemini/settings.json` (need to monkey-patch Path.home() or use helper path)
    - Project-scope servers written to `{tmpdir}/project/.gemini/settings.json`
    - User config has: api-server, port-server, plugin-tools (3 servers)
    - Project config has: project-db (1 server)

    **SYNC-02 (Codex scope routing):**
    - User-scope servers written to user config path
    - Project-scope servers written to project config path
    - User config has: api-server, port-server, plugin-tools (NOT sse-analytics)
    - Project config has: project-db

    **SYNC-03 (Plugin MCP user scope):**
    - plugin-tools appears in user-scope config for both Codex and Gemini
    - plugin-tools does NOT appear in project-scope config

    **SYNC-04 (Transport detection):**
    - sse-analytics skipped on Codex with warning containing "SSE"
    - sse-analytics included on Gemini (Gemini supports SSE)

    **ENV-01 (${VAR} translation):**
    - Codex config: api-server args contain "sk-test-integration-key" (resolved), NOT "${TEST_API_KEY}"
    - Codex config: api-server env map has TEST_API_KEY = "sk-test-integration-key"

    **ENV-02 (${VAR:-default}):**
    - Codex config: port-server args contain "3000" (default used), NOT "${UNDEFINED_PORT:-3000}"
    - Warnings include message about UNDEFINED_PORT using default

    **ENV-03 (Gemini preserves ${VAR}):**
    - Gemini config: api-server args still contain "${TEST_API_KEY}" literally
    - Gemini config: port-server args still contain "${UNDEFINED_PORT:-3000}" literally

    **Output format:**
    ```
    Testing Phase 10: Scope-Aware Target Sync & Environment Translation
    ====================================================================

    SYNC-01: Gemini scope routing
      [PASS] User-scope MCPs in ~/.gemini/settings.json (3 servers)
      [PASS] Project-scope MCPs in .gemini/settings.json (1 server)

    SYNC-02: Codex scope routing
      [PASS] User-scope MCPs in ~/.codex/config.toml (3 servers)
      [PASS] Project-scope MCPs in .codex/config.toml (1 server)

    ...

    Results: X/Y passed
    ```

    **Implementation note:** Since we can't easily monkey-patch Path.home() for Codex/Gemini user paths, verify the project-scope routing directly and verify user-scope routing by:
    1. Checking the SyncResult.synced_files list for user-scope path strings
    2. Checking that user-scope servers are NOT in the project-scope output file
    3. If possible, create a custom adapter subclass in the test that overrides the home path

    At the end, print final pass/fail summary and `sys.exit(0)` on all pass, `sys.exit(1)` on any fail.
  </action>
  <verify>
    Run: `python verify_phase10_integration.py`
    Expected: All checks pass, exit code 0 (Level 2: Proxy)

    Specifically verify:
    - Output shows PASS for all 7 requirement groups (SYNC-01..04, ENV-01..03)
    - No assertion errors or stack traces
    - Exit code 0
  </verify>
  <done>
    Integration test passes all checks for SYNC-01, SYNC-02, SYNC-03, SYNC-04, ENV-01, ENV-02, ENV-03.
    Codex: scope routing correct, env vars translated, SSE skipped with warning.
    Gemini: scope routing correct, env vars preserved, SSE included.
    Plugin MCPs routed to user scope on all targets.
    Phase 10 Success Criteria #8 verified.
  </done>
</task>

</tasks>

<verification>
Level 2 (Proxy):
- `python verify_phase10_integration.py` passes all requirement checks
- Exit code 0
- All 7 v2.0 requirements for Phase 10 verified in single integration test
</verification>

<success_criteria>
- verify_phase10_integration.py exists and runs successfully
- Tests cover all 7 Phase 10 requirements: SYNC-01, SYNC-02, SYNC-03, SYNC-04, ENV-01, ENV-02, ENV-03
- Test matches Success Criteria #8 specification: 2 user-scope MCPs (with env vars), 1 project-scope MCP, 1 plugin MCP
- All assertions pass with exit code 0
</success_criteria>

<output>
After completion, create `.planning/phases/10-scope-aware-target-sync-environment-translation/10-03-SUMMARY.md`
</output>
