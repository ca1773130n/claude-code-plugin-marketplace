---
phase: 07-packaging-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [.claude-plugin/plugin.json, .claude-plugin/marketplace.json, plugin.json]
autonomous: true
verification_level: sanity

must_haves:
  truths:
    - "plugin.json exists in .claude-plugin/ directory with valid JSON and all required fields (name, version, description, hooks, commands, mcp)"
    - "marketplace.json exists in .claude-plugin/ with GitHub source pointing to repository and version matching plugin.json"
    - "Root-level plugin.json is removed (only .claude-plugin/plugin.json exists)"
    - "commands/, hooks/, src/ directories remain at root level (not moved into .claude-plugin/)"
  artifacts:
    - path: ".claude-plugin/plugin.json"
      provides: "Plugin manifest in correct directory"
      contains: "HarnessSync"
    - path: ".claude-plugin/marketplace.json"
      provides: "Marketplace catalog for distribution"
      contains: "github"
  key_links:
    - from: ".claude-plugin/plugin.json"
      to: "commands/sync.md"
      via: "commands field reference"
      pattern: "commands/sync.md"
    - from: ".claude-plugin/plugin.json"
      to: "hooks/hooks.json"
      via: "hooks field reference"
      pattern: "hooks/hooks.json"
    - from: ".claude-plugin/plugin.json"
      to: "src/mcp/server.py"
      via: "mcp field reference"
      pattern: "src/mcp/server.py"
    - from: ".claude-plugin/marketplace.json"
      to: ".claude-plugin/plugin.json"
      via: "version consistency"
      pattern: "1.0.0"
---

<objective>
Move plugin.json into the correct `.claude-plugin/` directory per Claude Code plugin structure requirements, and create marketplace.json for distribution.

Purpose: Claude Code requires plugin.json inside `.claude-plugin/` (not at root). Components (commands/, hooks/, src/) must stay at root. Without this structural change, `claude plugin validate` will fail and the plugin cannot be installed from marketplace or GitHub.

Output: `.claude-plugin/plugin.json` (moved from root), `.claude-plugin/marketplace.json` (new), root `plugin.json` deleted.
</objective>

<execution_context>
@${CLAUDE_PLUGIN_ROOT}/references/execute-plan.md
@${CLAUDE_PLUGIN_ROOT}/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-packaging-distribution/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move plugin.json to .claude-plugin/ directory</name>
  <files>.claude-plugin/plugin.json, plugin.json</files>
  <action>
    1. Create `.claude-plugin/` directory at project root: `mkdir -p .claude-plugin/`

    2. Move the existing `plugin.json` from root into `.claude-plugin/plugin.json`. The content stays the same but with one addition — ensure `version` field is present and set to `"1.0.0"`.

    Current plugin.json content to preserve:
    ```json
    {
      "name": "HarnessSync",
      "version": "1.0.0",
      "description": "Sync Claude Code configuration to Codex, Gemini CLI, and OpenCode. Configure once, sync everywhere.",
      "author": "HarnessSync Contributors",
      "license": "MIT",
      "main": "src/",
      "hooks": "hooks/hooks.json",
      "skills": [],
      "commands": {
        "sync": "commands/sync.md",
        "sync-status": "commands/sync-status.md"
      },
      "mcp": {
        "server": "src/mcp/server.py",
        "tools": ["sync_all", "sync_target", "get_status"]
      }
    }
    ```

    3. Delete the root-level `plugin.json` file after confirming `.claude-plugin/plugin.json` is valid JSON (use `python3 -c "import json; json.load(open('.claude-plugin/plugin.json'))"` to verify).

    4. Verify that component directories remain at root:
       - `commands/` exists at root (NOT inside .claude-plugin/)
       - `hooks/` exists at root
       - `src/` exists at root

    IMPORTANT: Do NOT move commands/, hooks/, src/, or any other directories into .claude-plugin/. Only plugin.json and marketplace.json go there. This is the most common pitfall in Claude Code plugin packaging (see 07-RESEARCH.md Pitfall 1).
  </action>
  <verify>
    # Verify .claude-plugin/plugin.json exists and is valid JSON
    python3 -c "import json; d=json.load(open('.claude-plugin/plugin.json')); assert d['name']=='HarnessSync'; assert d['version']=='1.0.0'; print('OK')" (Level 1: Sanity)

    # Verify root plugin.json is removed
    test ! -f plugin.json && echo "Root plugin.json removed: OK" (Level 1: Sanity)

    # Verify components remain at root
    test -d commands && test -d hooks && test -d src && echo "Components at root: OK" (Level 1: Sanity)
  </verify>
  <done>
    .claude-plugin/plugin.json exists with all fields (name, version, description, author, license, main, hooks, skills, commands, mcp). Root plugin.json is deleted. commands/, hooks/, src/ directories remain at project root.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create marketplace.json for distribution</name>
  <files>.claude-plugin/marketplace.json</files>
  <action>
    Create `.claude-plugin/marketplace.json` with the following structure for GitHub-based distribution:

    ```json
    {
      "name": "harness-sync",
      "owner": {
        "name": "HarnessSync Contributors"
      },
      "metadata": {
        "description": "Sync Claude Code configuration to Codex, Gemini CLI, and OpenCode. Configure once, sync everywhere.",
        "version": "1.0.0"
      },
      "plugins": [
        {
          "name": "HarnessSync",
          "source": {
            "source": "github",
            "repo": "username/HarnessSync",
            "ref": "main"
          },
          "description": "Automatic config synchronization across AI coding harnesses. Configure Claude Code once, sync everywhere.",
          "version": "1.0.0",
          "author": {
            "name": "HarnessSync Contributors"
          },
          "homepage": "https://github.com/username/HarnessSync",
          "repository": "https://github.com/username/HarnessSync",
          "license": "MIT",
          "keywords": ["sync", "codex", "gemini", "opencode", "configuration", "automation"],
          "category": "productivity"
        }
      ]
    }
    ```

    Key decisions:
    - Use `"source": "github"` for public distribution (NOT relative paths, per 07-RESEARCH.md Pitfall 2)
    - Use `"repo": "username/HarnessSync"` as placeholder (user will update with actual GitHub username)
    - Pin `"ref": "main"` branch
    - Version MUST match plugin.json version (1.0.0)
    - Use `"username/HarnessSync"` as placeholder in repo and URLs — add comment at top of file is not possible in JSON, so note in SUMMARY that user must update the `username` placeholder

    After creation, validate:
    - JSON syntax valid: `python3 -c "import json; json.load(open('.claude-plugin/marketplace.json'))"`
    - Version matches plugin.json: extract both versions and compare
  </action>
  <verify>
    # Validate marketplace.json exists and is valid JSON
    python3 -c "import json; d=json.load(open('.claude-plugin/marketplace.json')); assert d['plugins'][0]['name']=='HarnessSync'; print('OK')" (Level 1: Sanity)

    # Validate version consistency between plugin.json and marketplace.json
    python3 -c "
import json
p = json.load(open('.claude-plugin/plugin.json'))
m = json.load(open('.claude-plugin/marketplace.json'))
assert p['version'] == m['metadata']['version'], f'Version mismatch: {p[\"version\"]} vs {m[\"metadata\"][\"version\"]}'
assert p['version'] == m['plugins'][0]['version'], f'Plugin version mismatch'
print('Version consistency: OK')
    " (Level 1: Sanity)

    # Validate GitHub source is used (not relative paths)
    python3 -c "
import json
m = json.load(open('.claude-plugin/marketplace.json'))
src = m['plugins'][0]['source']
assert src['source'] == 'github', f'Expected github source, got {src[\"source\"]}'
assert 'repo' in src, 'Missing repo field in source'
print('GitHub source: OK')
    " (Level 1: Sanity)
  </verify>
  <done>
    marketplace.json exists in .claude-plugin/ with GitHub source, version 1.0.0 matching plugin.json, all required metadata fields (name, owner, plugins array with source, description, version, author, license, keywords, category).
  </done>
</task>

</tasks>

<verification>
Level 1 (Sanity):
1. .claude-plugin/plugin.json exists and parses as valid JSON
2. .claude-plugin/marketplace.json exists and parses as valid JSON
3. Root plugin.json is deleted
4. commands/, hooks/, src/ directories exist at project root
5. Version in plugin.json matches version in marketplace.json (both metadata.version and plugins[0].version)
6. marketplace.json uses GitHub source (not relative paths)
7. plugin.json contains all required fields: name, version, description, hooks, commands, mcp

Level 2 (Proxy): N/A for this plan (structural changes only)

Level 3 (Deferred):
1. `claude plugin validate .` passes with no errors (requires Claude Code CLI)
2. `/plugin install github:username/HarnessSync` succeeds (requires published repository)
</verification>

<success_criteria>
- .claude-plugin/ directory exists with both plugin.json and marketplace.json
- Root plugin.json is removed
- All JSON files parse without errors
- Version consistency maintained (1.0.0 across both files)
- Component directories (commands/, hooks/, src/) remain at project root
- marketplace.json uses GitHub source for public distribution
</success_criteria>

<output>
After completion, create `.planning/phases/07-packaging-distribution/07-01-SUMMARY.md`
</output>
