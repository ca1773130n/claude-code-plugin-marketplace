---
phase: 07-packaging-distribution
plan: 03
type: execute
wave: 2
depends_on: [07-01, 07-02]
files_modified: [.github/workflows/validate.yml]
autonomous: true
verification_level: proxy

must_haves:
  truths:
    - "GitHub Actions workflow validates plugin structure, JSON syntax, version consistency, and install.sh on macOS/Linux/Windows matrix"
    - "Workflow checks .claude-plugin/plugin.json and .claude-plugin/marketplace.json exist and parse as valid JSON"
    - "Workflow verifies version consistency between plugin.json and marketplace.json"
    - "Workflow runs install.sh --dry-run on all platforms"
    - "Workflow lints shell scripts with shellcheck on Linux"
    - "All Level 1 (Sanity) and Level 2 (Proxy) verification checks pass locally"
  artifacts:
    - path: ".github/workflows/validate.yml"
      provides: "CI/CD workflow for cross-platform plugin validation"
      contains: "matrix"
  key_links:
    - from: ".github/workflows/validate.yml"
      to: ".claude-plugin/plugin.json"
      via: "JSON validation step"
      pattern: "plugin.json"
    - from: ".github/workflows/validate.yml"
      to: ".claude-plugin/marketplace.json"
      via: "JSON validation step"
      pattern: "marketplace.json"
    - from: ".github/workflows/validate.yml"
      to: "install.sh"
      via: "dry-run test step"
      pattern: "install.sh --dry-run"
---

<objective>
Create GitHub Actions CI workflow for automated cross-platform validation, then run all verification checks locally to confirm Phase 7 readiness.

Purpose: Automated CI catches directory structure errors, JSON schema issues, version mismatches, and platform-specific installation failures before users encounter them. Local verification confirms all Phase 7 success criteria are met.

Output: `.github/workflows/validate.yml` (CI workflow), local verification all passing.
</objective>

<execution_context>
@${CLAUDE_PLUGIN_ROOT}/references/execute-plan.md
@${CLAUDE_PLUGIN_ROOT}/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-packaging-distribution/07-RESEARCH.md
@.planning/phases/07-packaging-distribution/07-01-SUMMARY.md
@.planning/phases/07-packaging-distribution/07-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions validation workflow</name>
  <files>.github/workflows/validate.yml</files>
  <action>
    Create `.github/workflows/validate.yml` with a matrix strategy testing across ubuntu-latest, macos-latest, and windows-latest.

    Workflow structure:

    ```yaml
    name: Validate Plugin
    on:
      push:
        branches: [main]
      pull_request:
        branches: [main]

    jobs:
      validate:
        strategy:
          fail-fast: false
          matrix:
            os: [ubuntu-latest, macos-latest, windows-latest]
            python-version: ['3.10', '3.12']
        runs-on: ${{ matrix.os }}
        steps:
          - Checkout repository (actions/checkout@v4)
          - Setup Python (actions/setup-python@v5)
          - Verify directory structure:
            - .claude-plugin/ exists
            - .claude-plugin/plugin.json exists
            - .claude-plugin/marketplace.json exists
            - commands/ exists at root
            - hooks/ exists at root
            - src/ exists at root
            - install.sh exists and is executable
          - Validate JSON syntax (use python3 -c "import json; json.load(open(...))")
            - .claude-plugin/plugin.json
            - .claude-plugin/marketplace.json
            - hooks/hooks.json
          - Validate plugin.json required fields (name, version, description)
          - Validate version consistency (plugin.json version == marketplace.json version)
          - Test install.sh --dry-run (Unix only: if runner.os != 'Windows')
          - Test install.sh --dry-run on Windows (use bash shell: shell: bash)
          - Lint shell scripts with shellcheck (Linux only)
    ```

    Important workflow details:
    - Use `shell: bash` for all run steps (ensures Windows uses Git Bash)
    - Use `python3 -c "import json; ..."` instead of `jq` for JSON validation (jq may not be pre-installed on all runners, Python is guaranteed by setup-python)
    - Use `fail-fast: false` so all platform results are visible even if one fails
    - Python version matrix: test 3.10 (minimum) and 3.12 (current stable)
    - shellcheck step should use `|| true` or `continue-on-error: true` for non-blocking warnings
    - Windows step for install.sh should use `shell: bash` (Git Bash on windows-latest)
  </action>
  <verify>
    # Verify workflow file exists
    test -f .github/workflows/validate.yml && echo "Workflow file exists: OK" (Level 1: Sanity)

    # Verify YAML syntax (use python3 since yamllint may not be installed)
    python3 -c "
import re
with open('.github/workflows/validate.yml') as f:
    content = f.read()
# Basic checks
assert 'on:' in content, 'Missing trigger'
assert 'matrix:' in content, 'Missing matrix strategy'
assert 'ubuntu-latest' in content, 'Missing ubuntu'
assert 'macos-latest' in content, 'Missing macos'
assert 'windows-latest' in content, 'Missing windows'
assert 'plugin.json' in content, 'Missing plugin.json check'
assert 'marketplace.json' in content, 'Missing marketplace.json check'
assert 'install.sh' in content, 'Missing install.sh check'
print('Workflow structure: OK')
    " (Level 1: Sanity)
  </verify>
  <done>
    .github/workflows/validate.yml exists with matrix strategy (ubuntu/macos/windows x python 3.10/3.12), directory structure checks, JSON validation, version consistency check, install.sh dry-run test, shellcheck linting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run local verification and confirm Phase 7 readiness</name>
  <files></files>
  <action>
    Run all Level 1 (Sanity) and Level 2 (Proxy) verification checks locally to confirm Phase 7 deliverables are ready.

    Verification checklist (run each command, record pass/fail):

    **Level 1 — Sanity checks:**
    1. `.claude-plugin/plugin.json` exists and is valid JSON
    2. `.claude-plugin/marketplace.json` exists and is valid JSON
    3. `hooks/hooks.json` exists and is valid JSON
    4. Root-level `plugin.json` does NOT exist
    5. `commands/` directory exists at root with sync.md and sync-status.md
    6. `hooks/` directory exists at root with hooks.json
    7. `src/` directory exists at root with mcp/server.py
    8. `install.sh` is executable
    9. `shell-integration.sh` exists
    10. No `cc2all` references in install.sh or shell-integration.sh
    11. Version consistency: plugin.json version == marketplace.json metadata.version == marketplace.json plugins[0].version
    12. marketplace.json uses GitHub source type
    13. plugin.json has required fields: name, version, description, hooks, commands
    14. `.github/workflows/validate.yml` exists

    **Level 2 — Proxy checks:**
    1. `bash install.sh --dry-run` completes with exit code 0
    2. `bash -n shell-integration.sh` syntax check passes
    3. `bash -n install.sh` syntax check passes
    4. Plugin.json commands reference existing files (commands/sync.md, commands/sync-status.md)
    5. Plugin.json hooks reference existing file (hooks/hooks.json)
    6. Plugin.json MCP server references existing file (src/mcp/server.py)

    Run all checks as a single Python verification script. Print results in table format with pass/fail for each check.

    If any check fails, fix the issue before marking this task done. If fixes require changes to files from Plan 01 or 02, make minimal targeted fixes.
  </action>
  <verify>
    # Run comprehensive verification
    python3 -c "
import json, os, subprocess, sys

results = []
root = os.getcwd()

def check(name, condition):
    results.append((name, condition))

# Level 1: Sanity
check('plugin.json exists', os.path.isfile('.claude-plugin/plugin.json'))
check('marketplace.json exists', os.path.isfile('.claude-plugin/marketplace.json'))
check('hooks.json exists', os.path.isfile('hooks/hooks.json'))
check('root plugin.json removed', not os.path.isfile('plugin.json'))
check('commands/ at root', os.path.isdir('commands'))
check('hooks/ at root', os.path.isdir('hooks'))
check('src/ at root', os.path.isdir('src'))
check('install.sh executable', os.access('install.sh', os.X_OK))
check('shell-integration.sh exists', os.path.isfile('shell-integration.sh'))

# JSON validity
try:
    pj = json.load(open('.claude-plugin/plugin.json'))
    check('plugin.json valid JSON', True)
except: check('plugin.json valid JSON', False)

try:
    mj = json.load(open('.claude-plugin/marketplace.json'))
    check('marketplace.json valid JSON', True)
except: check('marketplace.json valid JSON', False)

# Version consistency
try:
    v1 = pj['version']
    v2 = mj['metadata']['version']
    v3 = mj['plugins'][0]['version']
    check('version consistency', v1 == v2 == v3)
except: check('version consistency', False)

# GitHub source
try:
    check('GitHub source', mj['plugins'][0]['source']['source'] == 'github')
except: check('GitHub source', False)

# Required fields
try:
    for f in ['name','version','description','hooks','commands']:
        assert f in pj
    check('plugin.json required fields', True)
except: check('plugin.json required fields', False)

check('CI workflow exists', os.path.isfile('.github/workflows/validate.yml'))

# Level 2: Proxy
r = subprocess.run(['bash', '-n', 'install.sh'], capture_output=True)
check('install.sh syntax', r.returncode == 0)

r = subprocess.run(['bash', '-n', 'shell-integration.sh'], capture_output=True)
check('shell-integration.sh syntax', r.returncode == 0)

r = subprocess.run(['bash', 'install.sh', '--dry-run'], capture_output=True)
check('install.sh --dry-run', r.returncode == 0)

# File references
check('commands/sync.md exists', os.path.isfile('commands/sync.md'))
check('commands/sync-status.md exists', os.path.isfile('commands/sync-status.md'))
check('hooks/hooks.json exists', os.path.isfile('hooks/hooks.json'))
check('src/mcp/server.py exists', os.path.isfile('src/mcp/server.py'))

# Print results
passed = sum(1 for _,v in results if v)
total = len(results)
print(f'\n{'='*50}')
print(f'Phase 7 Verification: {passed}/{total} passed')
print(f'{'='*50}')
for name, ok in results:
    status = 'PASS' if ok else 'FAIL'
    print(f'  [{status}] {name}')
print(f'\n{'='*50}')
sys.exit(0 if passed == total else 1)
    " (Level 2: Proxy)
  </verify>
  <done>
    All Level 1 (Sanity) and Level 2 (Proxy) verification checks pass. Phase 7 deliverables confirmed: .claude-plugin/ with valid plugin.json and marketplace.json, install.sh with --dry-run and HarnessSync branding, shell-integration.sh updated, CI workflow created, all file references valid.
  </done>
</task>

</tasks>

<verification>
Level 1 (Sanity):
1. .github/workflows/validate.yml exists with correct structure
2. Workflow references all three platforms (ubuntu, macos, windows)
3. Workflow validates plugin.json and marketplace.json
4. Workflow tests install.sh --dry-run

Level 2 (Proxy):
1. All 20+ local verification checks pass (JSON validity, structure, file references, syntax, dry-run)
2. Workflow file has valid YAML structure (basic parsing check)
3. install.sh --dry-run completes without errors
4. All file references in plugin.json point to existing files

Level 3 (Deferred):
1. GitHub Actions workflow passes on all three platforms after push (requires GitHub repository)
2. `claude plugin validate .` passes (requires Claude Code CLI)
3. `/plugin install github:username/HarnessSync` works (requires published repository)
4. Windows native/WSL2 installation testing (requires Windows environment)
5. End-to-end sync with Codex/Gemini/OpenCode installed (Phase 3 deferred validations)
</verification>

<success_criteria>
- .github/workflows/validate.yml exists with matrix strategy for 3 platforms x 2 Python versions
- All Level 1 and Level 2 verification checks pass locally
- No regressions in install.sh, shell-integration.sh, plugin.json, or marketplace.json
- Phase 7 requirements PKG-01 (marketplace), PKG-02 (GitHub installability), PKG-03 (install.sh) all have deliverables
</success_criteria>

<output>
After completion, create `.planning/phases/07-packaging-distribution/07-03-SUMMARY.md`
</output>
