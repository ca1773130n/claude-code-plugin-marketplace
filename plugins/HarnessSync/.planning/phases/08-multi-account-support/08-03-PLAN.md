---
phase: 08-multi-account-support
plan: 03
type: execute
wave: 2
depends_on: [08-01]
files_modified: [src/setup_wizard.py, src/commands/sync_setup.py, commands/sync-setup.md]
autonomous: true
verification_level: proxy

must_haves:
  truths:
    - "SetupWizard discovers Claude Code directories using AccountDiscovery and presents them to user"
    - "SetupWizard prompts for account name, source path selection, and per-target directory paths"
    - "SetupWizard validates all paths, detects target collisions, and writes accounts.json via AccountManager"
    - "/sync-setup command invokes SetupWizard in interactive mode or accepts --config-file for automation"
    - "Non-interactive mode detects non-TTY and fails fast with clear error message"
    - "Setup wizard suggests default target paths as ~/.{cli}-{account_name}"
  artifacts:
    - path: "src/setup_wizard.py"
      provides: "Interactive setup wizard for multi-account configuration"
      exports: ["SetupWizard"]
    - path: "src/commands/sync_setup.py"
      provides: "/sync-setup command entry point"
      exports: ["main"]
    - path: "commands/sync-setup.md"
      provides: "Slash command definition for /sync-setup"
  key_links:
    - from: "src/setup_wizard.py"
      to: "src/account_manager.py"
      via: "AccountManager for persistence"
      pattern: "from src\\.account_manager import AccountManager"
    - from: "src/setup_wizard.py"
      to: "src/account_discovery.py"
      via: "discover_claude_configs for source discovery"
      pattern: "from src\\.account_discovery import discover_claude_configs"
    - from: "src/commands/sync_setup.py"
      to: "src/setup_wizard.py"
      via: "SetupWizard instantiation"
      pattern: "from src\\.setup_wizard import SetupWizard"
---

<objective>
Create the interactive setup wizard for multi-account configuration and the /sync-setup slash command to invoke it.

Purpose: The setup wizard is the primary user-facing interface for configuring multi-account sync. It discovers Claude Code directories, guides users through account naming and target path selection, validates configuration, and persists to accounts.json. Following git config / poetry init / AWS CLI configure patterns from research.

Output: SetupWizard class (src/setup_wizard.py), /sync-setup command (src/commands/sync_setup.py + commands/sync-setup.md).
</objective>

<execution_context>
@${CLAUDE_PLUGIN_ROOT}/references/execute-plan.md
@${CLAUDE_PLUGIN_ROOT}/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-multi-account-support/08-RESEARCH.md
@.planning/phases/08-multi-account-support/08-01-SUMMARY.md
@src/commands/sync.py
@commands/sync.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SetupWizard with interactive discovery and configuration</name>
  <files>src/setup_wizard.py</files>
  <action>
    Create src/setup_wizard.py with the interactive setup wizard following git config / poetry init patterns from research:

    Class: SetupWizard
    - __init__(account_manager: AccountManager = None, config_dir: Path = None):
      * Create AccountManager if not provided
      * Store reference for CRUD operations

    - run_interactive() -> dict: Main wizard flow (returns account config dict or raises SystemExit)
      1. Print header: "HarnessSync Multi-Account Setup"
      2. Check sys.stdin.isatty() - fail fast if non-interactive
      3. Step 1: Discovery
         - Call discover_claude_configs() to find ~/.claude* directories
         - Call validate_claude_config() on each to filter false positives
         - Display numbered list of valid configs found
         - If none found, prompt for manual path entry
      4. Step 2: Source selection
         - Prompt user to select by number or enter custom path
         - Validate selected path is_dir()
      5. Step 3: Account naming
         - Suggest name derived from directory (e.g., .claude-work -> "work", .claude -> "default")
         - Prompt for account name with validation (non-empty, no spaces, alnum+dash+underscore)
         - Check if name already exists in AccountManager, warn and ask to overwrite
      6. Step 4: Target directory configuration
         - For each supported CLI (codex, gemini, opencode):
           * Suggest default path: ~/.{cli}-{account_name} (or ~/.{cli} if account is "default")
           * Prompt: "{cli} target directory [{default}]: "
           * Empty input accepts default
           * Validate: check for target path collision with existing accounts
      7. Step 5: Confirmation summary
         - Display: account name, source path, target paths
         - Prompt: "Save configuration? [Y/n]: "
         - 'n' cancels, anything else (including empty) confirms
      8. Step 6: Save
         - Call account_manager.add_account(name, source_path, targets)
         - Print success message with path to accounts.json
      9. Return the account config dict for caller use

    - run_add_account() -> dict: Shortcut that runs wizard for adding one account
      * Same as run_interactive() but skips header if accounts already exist
      * Prints "Adding new account..." instead of full header

    - run_list() -> None: List all configured accounts
      * Display table: account name, source path, target count, default marker

    - run_remove(account_name: str) -> bool: Remove an account
      * Confirm: "Remove account '{name}'? This cannot be undone. [y/N]: "
      * Default 'N' (conservative)
      * Call account_manager.remove_account()

    - _suggest_account_name(source_path: Path) -> str: Derive name from path
      * ".claude" -> "default"
      * ".claude-personal1" -> "personal1"
      * ".claude-work" -> "work"
      * Pattern: strip ".claude" prefix and leading "-"

    - _prompt_validated(prompt: str, validator: callable, error_msg: str, default: str = None) -> str:
      * Generic prompt-with-validation helper
      * Retries up to 3 times on validation failure
      * Returns validated input

    Use only stdlib: sys, pathlib, re.
    Follow research pitfall #4: detect non-TTY and fail fast.
    Follow research wizard flow (Section: Pattern 3: Setup Wizard Flow).
  </action>
  <verify>
    python -c "
import sys, os
sys.path.insert(0, '.')
from pathlib import Path
import tempfile

with tempfile.TemporaryDirectory() as td:
    config_dir = Path(td) / 'config'
    config_dir.mkdir()

    # Create mock source
    src = Path(td) / '.claude-work'
    src.mkdir()
    (src / 'settings.json').write_text('{}')

    from src.account_manager import AccountManager
    from src.setup_wizard import SetupWizard

    am = AccountManager(config_dir=config_dir)
    wizard = SetupWizard(account_manager=am)

    # Test _suggest_account_name
    assert wizard._suggest_account_name(Path.home() / '.claude') == 'default', 'Default name'
    assert wizard._suggest_account_name(Path.home() / '.claude-work') == 'work', 'Work name'
    assert wizard._suggest_account_name(Path.home() / '.claude-personal1') == 'personal1', 'Personal name'

    # Test run_list (should work with empty accounts)
    wizard.run_list()  # Should print 'No accounts configured'

    # Manually add account to test list
    am.add_account('work', src, {'codex': Path(td) / '.codex-work'})
    wizard.run_list()  # Should print account table

    # Test run_remove
    assert wizard.run_remove('nonexistent') is False, 'Remove nonexistent returns False'

    print('All SetupWizard tests passed')
" (Level 1: Sanity)
  </verify>
  <done>SetupWizard provides interactive multi-account configuration with discovery, validation, collision detection, and persistence. Non-interactive helper methods (list, remove, suggest_name) work without TTY.</done>
</task>

<task type="auto">
  <name>Task 2: Create /sync-setup command and slash command definition</name>
  <files>src/commands/sync_setup.py, commands/sync-setup.md</files>
  <action>
    Create the /sync-setup slash command following the pattern of /sync (src/commands/sync.py):

    1. src/commands/sync_setup.py:
       - PLUGIN_ROOT resolution (same pattern as sync.py)
       - sys.path.insert(0, PLUGIN_ROOT)
       - argparse-based argument parsing:
         * Subcommands: add (default), list, remove, show
         * --add: Run setup wizard to add new account (default action)
         * --list: List all configured accounts
         * --remove NAME: Remove account by name
         * --show NAME: Show detailed account config
         * --config-file PATH: Load accounts.json from file (non-interactive mode)
       - main() function:
         * Parse arguments
         * Route to appropriate SetupWizard method
         * Handle errors gracefully (print to stderr, exit 0 per decision #39)
       - If no arguments given, run interactive wizard (add mode)

    2. commands/sync-setup.md (slash command definition):
       Follow exact pattern from commands/sync.md:
       ```
       ---
       description: Configure multi-account sync setup (discover, add, remove accounts)
       ---

       Configure HarnessSync multi-account support.

       Usage: /sync-setup [--list] [--remove NAME] [--show NAME] [--config-file PATH]

       Default (no args): Run interactive setup wizard to add a new account.

       Options:
       - --list: List all configured accounts
       - --remove NAME: Remove account configuration
       - --show NAME: Show detailed account configuration
       - --config-file PATH: Import accounts from JSON file (non-interactive)

       !python ${CLAUDE_PLUGIN_ROOT}/src/commands/sync_setup.py $ARGUMENTS
       ```

    Follow patterns from existing commands:
    - sys.path resolution from sync.py
    - argparse with $ARGUMENTS via shlex.split
    - Exit 0 always (decision #39: never block Claude Code)
    - Print errors to stderr
  </action>
  <verify>
    python -c "
import sys, os
sys.path.insert(0, '.')
from pathlib import Path

# Verify command module imports correctly
from src.commands.sync_setup import main
print('sync_setup module imports successfully')

# Verify slash command definition exists and has correct format
cmd_file = Path('commands/sync-setup.md')
assert cmd_file.exists(), 'Command definition exists'
content = cmd_file.read_text()
assert '---' in content, 'Has frontmatter'
assert 'description:' in content, 'Has description'
assert 'sync_setup.py' in content, 'References implementation'
assert '\$ARGUMENTS' in content, 'Passes arguments'
print('Slash command definition valid')

print('All /sync-setup command tests passed')
" (Level 1: Sanity)

    python src/commands/sync_setup.py --list 2>/dev/null || true
    echo "Command executes without crash (exit code: $?)" (Level 2: Proxy)
  </verify>
  <done>/sync-setup command provides interactive setup wizard (default), --list for account listing, --remove for account deletion, --show for account details, and --config-file for non-interactive import. Slash command definition follows established HarnessSync pattern.</done>
</task>

</tasks>

<verification>
Level 1 (Sanity):
- SetupWizard._suggest_account_name correctly derives names from .claude* paths
- SetupWizard.run_list() works with empty and populated account registries
- /sync-setup command module imports without errors
- commands/sync-setup.md has valid frontmatter and references correct Python script
- --list flag executes without crash

Level 2 (Proxy):
- /sync-setup --list shows configured accounts in table format
- /sync-setup --remove NAME removes account and confirms
- Non-interactive detection (sys.stdin.isatty()) fails fast with clear message
- Account name suggestion derives "work" from ~/.claude-work

Level 3 (Deferred):
- Full interactive wizard flow with real user typing (requires TTY)
- Setup wizard with 5+ discovered directories
- --config-file import of externally created accounts.json
</verification>

<success_criteria>
1. SetupWizard discovers Claude Code directories and guides user through configuration
2. /sync-setup command provides CLI interface for all account management operations
3. Non-interactive environments get clear error message instead of hanging
4. Slash command definition enables /sync-setup in Claude Code sessions
</success_criteria>

<output>
After completion, create `.planning/phases/08-multi-account-support/08-03-SUMMARY.md`
</output>
