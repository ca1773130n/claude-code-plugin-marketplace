---
phase: 05-integration-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/run-e2e-test.sh
autonomous: true
verification_level: sanity

must_haves:
  truths:
    - "run-e2e-test.sh scaffolds a temporary plugin, validates, scores, generates marketplace, verifies entry, and cleans up"
    - "run-e2e-test.sh uses trap cleanup EXIT to guarantee cleanup even on failure or interrupt"
    - "Temporary plugin directory is removed and marketplace.json is restored after test"
    - "run-e2e-test.sh exits 0 on --help and exits 2 on unknown arguments"
    - "Scaffolded plugin scores >= 80 (based on template scoring 100/100)"
    - "Plugin appears in marketplace.json after generate-marketplace.sh runs"
    - "No Bash 4+ features, no sed -i, no GNU-specific flags"
  artifacts:
    - path: "scripts/run-e2e-test.sh"
      provides: "End-to-end integration test covering scaffold-to-marketplace pipeline"
      contains: "trap cleanup EXIT"
  key_links:
    - from: "scripts/run-e2e-test.sh"
      to: "scripts/new-plugin.sh"
      via: "plugin scaffolding invocation"
      pattern: "new-plugin\\.sh"
    - from: "scripts/run-e2e-test.sh"
      to: "scripts/validate-plugin.sh"
      via: "plugin validation invocation"
      pattern: "validate-plugin\\.sh"
    - from: "scripts/run-e2e-test.sh"
      to: "scripts/score-plugin.sh"
      via: "plugin scoring invocation"
      pattern: "score-plugin\\.sh"
    - from: "scripts/run-e2e-test.sh"
      to: "scripts/generate-marketplace.sh"
      via: "marketplace generation invocation"
      pattern: "generate-marketplace\\.sh"
    - from: "scripts/run-e2e-test.sh"
      to: ".claude-plugin/marketplace.json"
      via: "jq verification of plugin entry"
      pattern: "marketplace\\.json"
---

<objective>
Create the end-to-end integration test script that exercises the full plugin lifecycle pipeline.

Purpose: The E2E test validates that all scripts work together as a coherent pipeline: scaffolding a new plugin, validating it, scoring it, generating the marketplace manifest, and verifying the plugin appears in the manifest. This is the primary integration test for the marketplace infrastructure and a prerequisite for the self-test CI workflow (Plan 05-03).

Output: `scripts/run-e2e-test.sh` -- an executable bash script with cleanup trap, --help support, and step-by-step pipeline verification.
</objective>

<execution_context>
@${CLAUDE_PLUGIN_ROOT}/references/execute-plan.md
@${CLAUDE_PLUGIN_ROOT}/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-integration-hardening/05-RESEARCH.md

# Scripts invoked by the E2E test
@scripts/new-plugin.sh
@scripts/validate-plugin.sh
@scripts/score-plugin.sh
@scripts/generate-marketplace.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create run-e2e-test.sh with full pipeline coverage</name>
  <files>scripts/run-e2e-test.sh</files>
  <action>
    Create `scripts/run-e2e-test.sh` -- an end-to-end integration test that exercises the full plugin lifecycle.

    Follow existing script conventions:
    - Shebang: `#!/usr/bin/env bash`
    - `set -euo pipefail`
    - `SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"`
    - `REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"`

    **Structure (in order):**

    1. **Variable initialization:**
       ```bash
       TEMP_PLUGIN_NAME=""
       ```

    2. **Cleanup function with trap:**
       ```bash
       cleanup() {
         if [[ -n "$TEMP_PLUGIN_NAME" && -d "$REPO_ROOT/plugins/$TEMP_PLUGIN_NAME" ]]; then
           rm -rf "$REPO_ROOT/plugins/$TEMP_PLUGIN_NAME"
         fi
         git -C "$REPO_ROOT" checkout -- .claude-plugin/marketplace.json 2>/dev/null || true
       }
       trap cleanup EXIT
       ```
       This guarantees cleanup on normal exit, failure, and interrupt (Ctrl+C).

    3. **usage() function:**
       ```bash
       usage() {
         cat <<EOF
       Usage: $(basename "$0") [options]

       Runs end-to-end integration test of the full plugin pipeline:
         scaffold -> validate -> score -> generate marketplace -> verify -> cleanup

       Options:
         --help    Show this help message

       Exit codes:
         0  All E2E tests passed
         1  Test failure
         2  Usage error or missing dependencies
       EOF
         exit 0
       }
       ```

    4. **Argument parsing:**
       ```bash
       for arg in "$@"; do
         case "$arg" in
           --help|-h) usage ;;
           *) echo "Error: Unknown argument '$arg'. This script takes no arguments." >&2
              echo "Run '$(basename "$0") --help' for usage information." >&2
              exit 2 ;;
         esac
       done
       ```

    5. **Step 1 - Scaffold a disposable plugin:**
       ```bash
       TEMP_PLUGIN_NAME="e2e-test-$(date +%s)"
       echo "=== E2E Test: Step 1 - Scaffolding plugin '$TEMP_PLUGIN_NAME' ==="
       "$SCRIPT_DIR/new-plugin.sh" "$TEMP_PLUGIN_NAME" --description "E2E integration test plugin"
       echo "  OK: Plugin scaffolded at plugins/$TEMP_PLUGIN_NAME"
       ```

    6. **Step 2 - Validate the scaffolded plugin:**
       ```bash
       echo ""
       echo "=== E2E Test: Step 2 - Validating plugin ==="
       "$SCRIPT_DIR/validate-plugin.sh" "$REPO_ROOT/plugins/$TEMP_PLUGIN_NAME"
       echo "  OK: Validation passed"
       ```

    7. **Step 3 - Score the scaffolded plugin (must be >= 80):**
       ```bash
       echo ""
       echo "=== E2E Test: Step 3 - Scoring plugin ==="
       SCORE_JSON=$("$SCRIPT_DIR/score-plugin.sh" "$REPO_ROOT/plugins/$TEMP_PLUGIN_NAME" --json)
       TOTAL=$(echo "$SCORE_JSON" | jq '.total')
       echo "  Score: $TOTAL/100"
       if [[ "$TOTAL" -lt 80 ]]; then
         echo "  FAIL: Scaffolded plugin scored $TOTAL (expected >= 80)" >&2
         exit 1
       fi
       echo "  OK: Score meets threshold (>= 80)"
       ```

    8. **Step 4 - Generate marketplace.json:**
       ```bash
       echo ""
       echo "=== E2E Test: Step 4 - Generating marketplace.json ==="
       "$SCRIPT_DIR/generate-marketplace.sh"
       echo "  OK: marketplace.json generated"
       ```

    9. **Step 5 - Verify plugin appears in marketplace.json:**
       ```bash
       echo ""
       echo "=== E2E Test: Step 5 - Verifying marketplace entry ==="
       if ! jq -e ".plugins[] | select(.name == \"$TEMP_PLUGIN_NAME\")" \
           "$REPO_ROOT/.claude-plugin/marketplace.json" >/dev/null 2>&1; then
         echo "  FAIL: '$TEMP_PLUGIN_NAME' not found in marketplace.json" >&2
         exit 1
       fi
       echo "  OK: Plugin found in marketplace.json"
       ```

    10. **Success message:**
        ```bash
        echo ""
        echo "=== E2E Test: ALL PASSED ==="
        echo "  Pipeline: scaffold -> validate -> score -> generate -> verify"
        echo "  Plugin: $TEMP_PLUGIN_NAME (score: $TOTAL/100)"
        echo "  Cleanup: automatic via EXIT trap"
        ```

    Make the script executable: `chmod +x scripts/run-e2e-test.sh`.

    IMPORTANT considerations from research:
    - The cleanup function restores marketplace.json via `git checkout` to avoid polluting the working tree.
    - The E2E test must NEVER commit changes. It operates on the working tree only.
    - `generate-marketplace.sh` may emit warnings about upstream fetches if `gh` is not authenticated. This is expected and does not affect the test.
    - No Bash 4+ features. No `sed -i`. No GNU-specific flags.
  </action>
  <verify>
    Run `./scripts/run-e2e-test.sh --help; echo "EXIT: $?"` -- must show usage and print "EXIT: 0". (Level 1: Sanity)
    Run `./scripts/run-e2e-test.sh --badarg; echo "EXIT: $?"` -- must print error and print "EXIT: 2". (Level 1: Sanity)
    Run `./scripts/run-e2e-test.sh` -- must complete all 5 steps and print "ALL PASSED" with exit 0. (Level 1: Sanity)
    After run-e2e-test.sh completes, verify cleanup worked:
      - `ls plugins/ | grep e2e-test` returns nothing (temp plugin removed). (Level 1: Sanity)
      - `git -C . diff --name-only .claude-plugin/marketplace.json` returns nothing (marketplace restored). (Level 1: Sanity)
    Run `./scripts/run-fixture-tests.sh` -- must still pass (no regression). (Level 1: Sanity)
  </verify>
  <done>run-e2e-test.sh exists, is executable, exercises the full scaffold-to-marketplace pipeline in 5 steps, cleans up automatically via EXIT trap, exits 0 on success, exits 0 on --help, exits 2 on unknown args, and leaves no residual files in the working tree.</done>
</task>

</tasks>

<verification>
Level 1 (Sanity):
- `./scripts/run-e2e-test.sh` completes with exit 0 and prints "ALL PASSED"
- `./scripts/run-e2e-test.sh --help` exits 0
- No temp plugin directories remain after execution
- marketplace.json is unchanged after execution (git diff shows no changes)
- Existing fixture tests still pass

Level 2 (Proxy):
- E2E test completes in < 30 seconds locally (based on research baseline of ~9.5s for 5 plugins)
- Scaffolded plugin scores >= 80 (template scores 100)
</verification>

<success_criteria>
- run-e2e-test.sh exercises the complete pipeline: scaffold -> validate -> score -> generate -> verify
- Cleanup trap guarantees no residual files on success, failure, or interrupt
- Script follows all project conventions (shebang, set flags, SCRIPT_DIR/REPO_ROOT, usage pattern)
- Consistent --help (exit 0) and unknown-arg (exit 2) behavior
- No Bash 4+ features, no sed -i, no GNU-specific flags
</success_criteria>

<output>
After completion, create `.planning/phases/05-integration-hardening/05-02-SUMMARY.md`
</output>
