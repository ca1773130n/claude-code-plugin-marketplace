---
phase: 05-integration-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/validate-local.sh
  - scripts/run-fixture-tests.sh
autonomous: true
verification_level: sanity

must_haves:
  truths:
    - "validate-local.sh --help exits 0 (not exit 2)"
    - "run-fixture-tests.sh --help exits 0 and prints usage information"
    - "run-fixture-tests.sh rejects unknown arguments with exit 2"
    - "run-fixture-tests.sh still passes all 11 tests after modification"
    - "All 6 existing scripts exit 0 on --help and exit 2 on unknown flags"
    - "No Bash 4+ features, no sed -i, no GNU-specific flags in any modified file"
  artifacts:
    - path: "scripts/validate-local.sh"
      provides: "Local validation wrapper with corrected --help exit code"
      contains: "exit 0"
    - path: "scripts/run-fixture-tests.sh"
      provides: "Fixture test runner with --help support and argument rejection"
      contains: "usage()"
  key_links:
    - from: "scripts/run-fixture-tests.sh"
      to: "scripts/validate-plugin.sh"
      via: "script invocation for each fixture"
      pattern: "validate-plugin\\.sh"
    - from: "scripts/validate-local.sh"
      to: "scripts/validate-plugin.sh"
      via: "script invocation"
      pattern: "validate-plugin\\.sh"
    - from: "scripts/validate-local.sh"
      to: "scripts/score-plugin.sh"
      via: "script invocation"
      pattern: "score-plugin\\.sh"
---

<objective>
Harden exit codes and --help compliance across validate-local.sh and run-fixture-tests.sh.

Purpose: Phase 5 success criteria require all scripts to exit 0 on --help and exit 2 on invalid arguments. Two scripts currently violate this: validate-local.sh exits 2 on --help, and run-fixture-tests.sh has no --help support at all and silently ignores unknown arguments. These fixes are prerequisites for the self-test workflow (Plan 05-03) which verifies --help compliance across all scripts.

Output: Updated `scripts/validate-local.sh` and `scripts/run-fixture-tests.sh` with consistent error handling.
</objective>

<execution_context>
@${CLAUDE_PLUGIN_ROOT}/references/execute-plan.md
@${CLAUDE_PLUGIN_ROOT}/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-integration-hardening/05-RESEARCH.md

# Scripts to modify
@scripts/validate-local.sh
@scripts/run-fixture-tests.sh

# Reference scripts with correct patterns
@scripts/validate-plugin.sh
@scripts/score-plugin.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix validate-local.sh --help exit code</name>
  <files>scripts/validate-local.sh</files>
  <action>
    In `scripts/validate-local.sh`, change the `usage()` function's exit code from `exit 2` to `exit 0`.

    The current usage() function ends with `exit 2`, which makes `--help` appear as an error. Per POSIX convention and the project's success criteria, `--help` is informational and must exit 0.

    Specifically:
    1. Find the `usage()` function (around line 8-24)
    2. Change the final `exit 2` inside the function to `exit 0`
    3. Do NOT change anything else -- the `no args` case at line 28-30 calls `usage()` and should now also exit 0 when invoked with no arguments. However, since validate-local.sh requires a plugin-dir argument, the no-args case should exit 2, NOT call usage().

    Wait -- on re-examination: the current code calls `usage` when `$# -eq 0`, which would now exit 0 instead of 2. This is incorrect for "no arguments" which IS a usage error. The fix requires separating the two cases:
    - `--help` calls `usage()` which exits 0 (informational)
    - `no args` should print a short error and exit 2, OR call a separate error handler

    Approach: Change `usage()` to exit 0. Replace the `$# -eq 0` block to print a brief error message pointing to --help, then exit 2. For example:
    ```
    if [[ $# -eq 0 ]]; then
      echo "Error: Missing required argument <plugin-dir>" >&2
      echo "Run '$(basename "$0") --help' for usage information." >&2
      exit 2
    fi
    ```

    This pattern is consistent with how `new-plugin.sh` handles missing arguments (line 46-49 of that script).

    IMPORTANT: Do not change any other behavior. The script must still resolve relative paths, check directory existence, run validation, and run scoring exactly as before.
  </action>
  <verify>
    Run `./scripts/validate-local.sh --help; echo "EXIT: $?"` -- must show usage text and print "EXIT: 0". (Level 1: Sanity)
    Run `./scripts/validate-local.sh; echo "EXIT: $?"` -- must print error and print "EXIT: 2". (Level 1: Sanity)
    Run `./scripts/validate-local.sh --badarg; echo "EXIT: $?"` -- must print error and print "EXIT: 2". (Level 1: Sanity)
    Run `./scripts/validate-local.sh plugins/GRD` -- must exit 0 with validation + scoring output. (Level 1: Sanity)
  </verify>
  <done>validate-local.sh exits 0 on --help, exits 2 on missing args and unknown flags, and still works correctly for valid plugin directories.</done>
</task>

<task type="auto">
  <name>Task 2: Add --help support and argument rejection to run-fixture-tests.sh</name>
  <files>scripts/run-fixture-tests.sh</files>
  <action>
    Add a `usage()` function and argument parsing to `scripts/run-fixture-tests.sh`.

    Currently the script has no argument handling at all. It ignores all arguments including `--help` and `--badarg`, and runs the full test suite regardless.

    Insert the following BEFORE the `passed=0` line (after the `VALIDATE=` line, around line 6):

    1. A `usage()` function:
       ```bash
       usage() {
         cat <<EOF
       Usage: $(basename "$0") [options]

       Runs the fixture test suite, validating all test fixtures under tests/fixtures/
       and both real plugins. Expects specific exit codes from validate-plugin.sh.

       Test coverage:
         - 4 valid fixtures (expect exit 0)
         - 4 invalid fixtures (expect exit 1)
         - 1 extra-fields fixture (expect exit 0 by design)
         - 2 real plugins (expect exit 0)

       Options:
         --help    Show this help message

       Exit codes:
         0  All tests passed
         1  One or more tests failed
         2  Usage error
       EOF
         exit 0
       }
       ```

    2. An argument parsing loop:
       ```bash
       for arg in "$@"; do
         case "$arg" in
           --help|-h) usage ;;
           -*) echo "Error: Unknown option '$arg'" >&2; exit 2 ;;
         esac
       done
       ```

    3. Reject any positional arguments (since run-fixture-tests.sh takes no arguments):
       ```bash
       if [[ $# -gt 0 ]]; then
         echo "Error: This script takes no arguments. Use --help for usage." >&2
         exit 2
       fi
       ```

    Wait -- the arg parsing loop above already handles `--help` and unknown options. For unknown positional args (no leading dash), we need an additional case. Revise the loop:
       ```bash
       for arg in "$@"; do
         case "$arg" in
           --help|-h) usage ;;
           *) echo "Error: Unknown argument '$arg'. This script takes no arguments." >&2
              echo "Run '$(basename "$0") --help' for usage information." >&2
              exit 2 ;;
         esac
       done
       ```

    This catches both `--badarg` and positional args like `foo`.

    IMPORTANT: Do NOT modify the test runner logic, the fixture list, or the run_test function. Only add the usage/arg-handling block above the existing test logic. Do NOT use Bash 4+ features.
  </action>
  <verify>
    Run `./scripts/run-fixture-tests.sh --help; echo "EXIT: $?"` -- must show usage text and print "EXIT: 0". (Level 1: Sanity)
    Run `./scripts/run-fixture-tests.sh --badarg; echo "EXIT: $?"` -- must print error and print "EXIT: 2". (Level 1: Sanity)
    Run `./scripts/run-fixture-tests.sh foo; echo "EXIT: $?"` -- must print error and print "EXIT: 2". (Level 1: Sanity)
    Run `./scripts/run-fixture-tests.sh` -- must run all 11 tests and exit 0 with "All tests passed." (Level 1: Sanity)
    Verify no Bash 4+ features: `grep -n 'declare -A' scripts/run-fixture-tests.sh` returns nothing.
  </verify>
  <done>run-fixture-tests.sh has usage() function, exits 0 on --help, exits 2 on unknown arguments, and still passes all 11 fixture tests with no behavior change to the test runner logic.</done>
</task>

</tasks>

<verification>
Level 1 (Sanity):
- `./scripts/validate-local.sh --help` exits 0
- `./scripts/run-fixture-tests.sh --help` exits 0
- `./scripts/run-fixture-tests.sh --badarg` exits 2
- `./scripts/validate-local.sh --badarg` exits 2
- `./scripts/run-fixture-tests.sh` passes all 11 tests (no regression)
- `./scripts/validate-local.sh plugins/GRD` exits 0 (no regression)
- All 6 scripts now exit 0 on --help:
  - `for s in scripts/*.sh; do ./"$s" --help >/dev/null 2>&1; echo "$s: $?"; done`

Level 2 (Proxy):
- validate-local.sh with no args exits 2 (not 0)
- run-fixture-tests.sh with positional arg exits 2
</verification>

<success_criteria>
- All 6 scripts in scripts/ exit 0 on --help
- All 6 scripts exit 2 on unknown flags (--badarg)
- run-fixture-tests.sh has a usage() function with test coverage description
- No regressions: fixture tests pass, validate-local.sh works on real plugins
- No Bash 4+ features introduced
</success_criteria>

<output>
After completion, create `.planning/phases/05-integration-hardening/05-01-SUMMARY.md`
</output>
