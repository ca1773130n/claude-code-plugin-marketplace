---
phase: 03-quality-gates-scoring
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - schemas/marketplace.schema.json
  - scripts/generate-marketplace.sh
  - QUALITY.md
autonomous: true
verification_level: proxy

must_haves:
  truths:
    - "marketplace.schema.json accepts qualityScore as optional integer 0-100 on each plugin entry"
    - "generate-marketplace.sh calls score-plugin.sh for each plugin and includes qualityScore in output"
    - "Generated marketplace.json passes schema validation with qualityScore fields present"
    - "QUALITY.md documents the 5-category rubric with all 28 rules and improvement guidance"
    - "QUALITY.md documents recommended branch protection settings"
  artifacts:
    - path: "schemas/marketplace.schema.json"
      provides: "Updated schema with qualityScore field"
      contains: "qualityScore"
    - path: "scripts/generate-marketplace.sh"
      provides: "Marketplace generation with quality score enrichment"
      contains: "score-plugin"
    - path: "QUALITY.md"
      provides: "Rubric documentation and branch protection guidance"
      min_lines: 80
  key_links:
    - from: "scripts/generate-marketplace.sh"
      to: "scripts/score-plugin.sh"
      via: "script invocation to get quality score"
      pattern: "score-plugin\\.sh"
    - from: "schemas/marketplace.schema.json"
      to: ".claude-plugin/marketplace.json"
      via: "schema validation of generated output"
      pattern: "qualityScore"
---

<objective>
Update marketplace infrastructure to include quality scores and create rubric documentation. Add qualityScore to the marketplace schema, integrate score-plugin.sh into generate-marketplace.sh, and create QUALITY.md documenting the rubric and branch protection recommendations.

Purpose: Make quality scores visible in the marketplace manifest and provide documentation for plugin authors to understand and improve their scores.
Output: Updated schema and generation script, QUALITY.md rubric documentation.
Research basis: Schema update follows Research Pitfall 3 (avoid breaking change by updating schema and script together). Branch protection documented per Research recommendation (one-time manual setup).
</objective>

<execution_context>
@${CLAUDE_PLUGIN_ROOT}/workflows/execute-plan.md
@${CLAUDE_PLUGIN_ROOT}/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-quality-gates-scoring/03-RESEARCH.md
@.planning/phases/03-quality-gates-scoring/03-01-SUMMARY.md
@schemas/marketplace.schema.json
@scripts/generate-marketplace.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add qualityScore to marketplace schema and integrate scoring into generate-marketplace.sh</name>
  <files>schemas/marketplace.schema.json, scripts/generate-marketplace.sh</files>
  <action>
    **Part A: Update schemas/marketplace.schema.json**

    Add `qualityScore` as an optional field to the `pluginEntry` definition:
    ```json
    "qualityScore": {
      "type": "integer",
      "minimum": 0,
      "maximum": 100,
      "description": "Quality score from automated rubric (0-100)"
    }
    ```
    Place it after the existing enrichment fields (commands, agents, hooks, mcpServers, lspServers).
    Do NOT make it required -- it is optional.

    Per Research Pitfall 3: Schema and generation script MUST be updated in the same commit
    to avoid the publish workflow's self-validation failing.

    **Part B: Update scripts/generate-marketplace.sh**

    Modify the plugin entry assembly loop to call score-plugin.sh and include the quality score:

    1. After the existing enrichment field computation (commands_count, agents_count, hooks_count),
       add:
       ```bash
       quality_score=0
       if [[ -x "$SCRIPT_DIR/score-plugin.sh" ]]; then
         quality_score=$(./scripts/score-plugin.sh "$plugin_dir" --json 2>/dev/null | jq '.total // 0')
       fi
       ```

    2. Add `--argjson qualityScore "$quality_score"` to the jq entry construction.

    3. Add `qualityScore: $qualityScore` to the jq object template (after hooks).

    4. Make sure qualityScore is always included (integer, not null-filtered) since score-plugin.sh
       always produces a numeric total.

    Test: Run `./scripts/generate-marketplace.sh` and verify:
    - Output includes qualityScore for each plugin
    - Self-validation against updated schema passes
    - GRD qualityScore matches `./scripts/score-plugin.sh plugins/GRD --json | jq '.total'`
  </action>
  <verify>
    # Schema accepts qualityScore
    echo '{"name":"test","source":"./test","qualityScore":75}' | \
      jq '.' | npx ajv validate -s schemas/marketplace.schema.json \
      --spec=draft7 -d /dev/stdin 2>&1 || true
    # (Above is a rough check; the real validation is the full marketplace generation below)

    # Regenerate marketplace.json with scores
    ./scripts/generate-marketplace.sh

    # Verify qualityScore fields are present
    jq '.plugins[].qualityScore' .claude-plugin/marketplace.json

    # Verify schema validation passes (built into generate-marketplace.sh)
    # (Already runs as part of generate-marketplace.sh)

    # Cross-check: score matches direct scoring
    DIRECT=$(./scripts/score-plugin.sh plugins/GRD --json | jq '.total')
    MARKET=$(jq '.plugins[] | select(.name == "grd") | .qualityScore' .claude-plugin/marketplace.json)
    test "$DIRECT" -eq "$MARKET"

    (Level 2: Proxy)
  </verify>
  <done>
    marketplace.schema.json has qualityScore field (optional integer 0-100).
    generate-marketplace.sh calls score-plugin.sh for each plugin and includes qualityScore
    in the output. Generated marketplace.json passes schema validation with qualityScore present.
    Quality scores match direct score-plugin.sh output.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create QUALITY.md documenting the rubric, scoring guide, and branch protection</name>
  <files>QUALITY.md</files>
  <action>
    Create QUALITY.md at the repository root with the following sections:

    **# Quality Scoring Rubric**

    Brief introduction: plugins are scored 0-100 across 5 categories of 20 points each.
    Subtractive model -- start at 20, lose points for each failed check.

    **## Categories**

    For each of the 5 categories, document:
    - Category name and max points (20)
    - Table of all rules with: Rule description, Deduction points, When it applies
    - Brief explanation of the category's intent

    Categories:
    1. Manifest Completeness (20 pts) -- 8 rules
    2. Documentation (20 pts) -- 5 rules
    3. Structure Integrity (20 pts) -- 5 rules
    4. Naming Conventions (20 pts) -- 6 rules
    5. Version Hygiene (20 pts) -- 6 rules (note: actually the rule counts from research -- total 28 rules, but may differ slightly from exact distribution, which is fine)

    IMPORTANT: The exact rules and deductions MUST match what score-plugin.sh implements
    (from Plan 03-01). Read the actual script to get the precise rules.

    **## How Scoring Works**

    - Explain subtractive model
    - Explain that scoring is informational (not a merge gate in Phase 3)
    - Show example: "If your plugin is missing homepage (-2) and license (-2), your Manifest Completeness score is 16/20"

    **## Improving Your Score**

    For each category, provide 2-3 specific, actionable tips:
    - "Add a `homepage` field to plugin.json pointing to your GitHub repo URL"
    - "Create a CHANGELOG.md file to track version changes"
    - "Ensure all agent .md files in your agents/ directory are listed in the manifest"

    **## Running Locally**

    Show exact commands:
    ```bash
    # Human-readable output
    ./scripts/score-plugin.sh plugins/YOUR_PLUGIN

    # Machine-readable JSON
    ./scripts/score-plugin.sh plugins/YOUR_PLUGIN --json
    ```

    **## Branch Protection (Recommended)**

    Document the recommended GitHub branch protection settings for the main branch:
    - Require pull request reviews (1 reviewer minimum)
    - Require status checks to pass: `Validate Plugins / validate-plugins`, `Validate Plugins / test-fixtures`
    - Require branch to be up to date before merging
    - Do not allow force pushes
    - Do not allow deletions

    Note: These are configured in GitHub Settings > Branches > Branch protection rules.
    Include a brief note that this is a one-time manual setup by the repository admin.
    Optionally include a `gh api` one-liner for reference (per Research recommendation).

    **## Score in CI**

    Brief explanation that quality scores appear as PR comments (when the CI integration
    from Plan 03-03 is active) and in marketplace.json.

    Keep the document concise and actionable. Target 80-150 lines.
  </action>
  <verify>
    # File exists and has sufficient content
    test -f QUALITY.md
    wc -l QUALITY.md  # expect >= 80 lines

    # Contains key sections
    grep -q "Manifest Completeness" QUALITY.md
    grep -q "Documentation" QUALITY.md
    grep -q "Structure Integrity" QUALITY.md
    grep -q "Naming Conventions" QUALITY.md
    grep -q "Version Hygiene" QUALITY.md
    grep -q "Branch Protection" QUALITY.md
    grep -q "score-plugin.sh" QUALITY.md

    (Level 1: Sanity)
  </verify>
  <done>
    QUALITY.md exists at repo root, documents all 5 categories with their rules and deductions
    (matching score-plugin.sh implementation), provides improvement guidance, explains local
    scoring commands, and documents recommended branch protection settings. 80-150 lines,
    concise and actionable.
  </done>
</task>

</tasks>

<verification>
Level 1 (Sanity):
- QUALITY.md exists with all 5 categories documented
- marketplace.schema.json contains qualityScore field definition
- generate-marketplace.sh references score-plugin.sh

Level 2 (Proxy):
- generate-marketplace.sh produces marketplace.json with qualityScore fields
- marketplace.json passes schema validation after adding qualityScore
- Quality scores in marketplace.json match direct score-plugin.sh output

Level 3 (Deferred):
- publish-marketplace.yml auto-commits marketplace.json with qualityScore (requires GitHub Actions run)
</verification>

<success_criteria>
- marketplace.schema.json has qualityScore as optional integer (0-100) on pluginEntry
- generate-marketplace.sh calls score-plugin.sh and includes qualityScore in marketplace.json
- Generated marketplace.json passes schema validation
- QUALITY.md documents rubric (5 categories, all rules), improvement tips, local usage, branch protection
- No breaking changes to existing marketplace.json validation
</success_criteria>

<output>
After completion, create `.planning/phases/03-quality-gates-scoring/03-02-SUMMARY.md`
</output>
