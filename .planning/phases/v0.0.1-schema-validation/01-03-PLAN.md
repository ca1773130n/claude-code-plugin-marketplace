---
phase: 01-schema-validation
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - tests/fixtures/valid-minimal/.claude-plugin/plugin.json
  - tests/fixtures/valid-commands-only/.claude-plugin/plugin.json
  - tests/fixtures/valid-commands-only/workflows/example.md
  - tests/fixtures/valid-hooks-only/.claude-plugin/plugin.json
  - tests/fixtures/valid-hooks-only/scripts/setup.sh
  - tests/fixtures/valid-full/.claude-plugin/plugin.json
  - tests/fixtures/valid-full/commands/example.md
  - tests/fixtures/valid-full/agents/full-example-agent.md
  - tests/fixtures/valid-full/hooks/hooks.json
  - tests/fixtures/invalid-no-name/.claude-plugin/plugin.json
  - tests/fixtures/invalid-bad-version/.claude-plugin/plugin.json
  - tests/fixtures/invalid-bad-paths/.claude-plugin/plugin.json
  - tests/fixtures/invalid-missing-files/.claude-plugin/plugin.json
  - tests/fixtures/invalid-extra-fields/.claude-plugin/plugin.json
  - scripts/run-fixture-tests.sh
autonomous: true
verification_level: sanity

must_haves:
  truths:
    - "validate-plugin.sh exits 0 for all 4 valid fixtures (valid-minimal, valid-commands-only, valid-hooks-only, valid-full)"
    - "validate-plugin.sh exits 1 for all 5 invalid fixtures with descriptive error messages"
    - "invalid-no-name fixture triggers schema error about missing required name field"
    - "invalid-bad-version fixture triggers schema error about version pattern"
    - "invalid-bad-paths fixture triggers schema error about path pattern (not starting with ./)"
    - "invalid-missing-files fixture triggers structural error about file not found"
    - "run-fixture-tests.sh runs all 9 fixtures and reports pass/fail summary"
    - "Both real plugins (GRD, multi-cli-harness) still pass when run through the fixture test runner"
  artifacts:
    - path: "tests/fixtures/valid-minimal/.claude-plugin/plugin.json"
      provides: "Minimal valid plugin fixture (name only)"
      contains: "name"
    - path: "tests/fixtures/valid-commands-only/.claude-plugin/plugin.json"
      provides: "Valid plugin with commands array (GRD-like)"
      contains: "commands"
    - path: "tests/fixtures/valid-hooks-only/.claude-plugin/plugin.json"
      provides: "Valid plugin with inline hooks (multi-cli-harness-like)"
      contains: "hooks"
    - path: "tests/fixtures/valid-full/.claude-plugin/plugin.json"
      provides: "Valid plugin with all optional fields populated"
      contains: "commands"
    - path: "tests/fixtures/invalid-no-name/.claude-plugin/plugin.json"
      provides: "Invalid fixture missing required name field"
    - path: "tests/fixtures/invalid-bad-version/.claude-plugin/plugin.json"
      provides: "Invalid fixture with non-semver version"
    - path: "tests/fixtures/invalid-bad-paths/.claude-plugin/plugin.json"
      provides: "Invalid fixture with absolute or non-relative paths"
    - path: "tests/fixtures/invalid-missing-files/.claude-plugin/plugin.json"
      provides: "Invalid fixture with commands pointing to nonexistent files"
    - path: "tests/fixtures/invalid-extra-fields/.claude-plugin/plugin.json"
      provides: "Fixture with unknown top-level fields (warning, not error)"
    - path: "scripts/run-fixture-tests.sh"
      provides: "Test runner that validates all fixtures and real plugins"
      min_lines: 40
  key_links:
    - from: "scripts/run-fixture-tests.sh"
      to: "scripts/validate-plugin.sh"
      via: "invokes validate-plugin.sh for each fixture"
      pattern: "validate-plugin\\.sh"
    - from: "tests/fixtures/valid-commands-only/.claude-plugin/plugin.json"
      to: "tests/fixtures/valid-commands-only/workflows/example.md"
      via: "commands array references the file, structural validator checks existence"
---

<objective>
Create the test fixture directory with 9 fixtures (4 valid, 5 invalid) and a test runner script that validates all fixtures and both real plugins.

Purpose: Fixtures prove the validation pipeline works correctly for both positive and negative cases. The test runner provides a single command to verify everything still works, which CI (Phase 2) and integration tests (Phase 5) will depend on. This is the final validation that Phase 1 meets its success criteria.

Output: 9 fixture plugin directories, a test runner script, and proof that all fixtures produce expected results.
</objective>

<context>
@.planning/ROADMAP.md
@.planning/phases/01-schema-validation/01-RESEARCH.md
@.planning/phases/01-schema-validation/01-01-SUMMARY.md
@.planning/phases/01-schema-validation/01-02-SUMMARY.md
@schemas/plugin.schema.json
@scripts/validate-plugin.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create all 9 test fixture plugins</name>
  <files>
    tests/fixtures/valid-minimal/.claude-plugin/plugin.json,
    tests/fixtures/valid-commands-only/.claude-plugin/plugin.json,
    tests/fixtures/valid-commands-only/workflows/example.md,
    tests/fixtures/valid-hooks-only/.claude-plugin/plugin.json,
    tests/fixtures/valid-hooks-only/scripts/setup.sh,
    tests/fixtures/valid-full/.claude-plugin/plugin.json,
    tests/fixtures/valid-full/commands/example.md,
    tests/fixtures/valid-full/agents/full-example-agent.md,
    tests/fixtures/valid-full/hooks/hooks.json,
    tests/fixtures/invalid-no-name/.claude-plugin/plugin.json,
    tests/fixtures/invalid-bad-version/.claude-plugin/plugin.json,
    tests/fixtures/invalid-bad-paths/.claude-plugin/plugin.json,
    tests/fixtures/invalid-missing-files/.claude-plugin/plugin.json,
    tests/fixtures/invalid-extra-fields/.claude-plugin/plugin.json
  </files>
  <action>
    Create `tests/fixtures/` directory and all 9 fixture subdirectories.

    **VALID FIXTURES (must pass both schema and structural validation):**

    1. **valid-minimal** -- Minimal valid plugin (only required field):
       ```json
       { "name": "valid-minimal" }
       ```
       No other files needed. Just `.claude-plugin/plugin.json`.

    2. **valid-commands-only** -- GRD-like plugin with commands array:
       ```json
       {
         "name": "valid-commands-only",
         "version": "1.0.0",
         "description": "Test fixture with commands array",
         "author": { "name": "Test Author" },
         "commands": ["./workflows/example.md"]
       }
       ```
       Also create `workflows/example.md` with a simple markdown file (one line: `# Example Command`).

    3. **valid-hooks-only** -- multi-cli-harness-like plugin with inline hooks:
       ```json
       {
         "name": "valid-hooks-only",
         "version": "2.0.0",
         "description": "Test fixture with inline hooks",
         "author": { "name": "Test Author" },
         "hooks": {
           "SessionStart": [
             {
               "hooks": [
                 {
                   "type": "command",
                   "command": "bash \"${CLAUDE_PLUGIN_ROOT}/scripts/setup.sh\" 2>&1 || true"
                 }
               ]
             }
           ]
         }
       }
       ```
       Also create `scripts/setup.sh` with `#!/usr/bin/env bash` and `echo "Setup complete"`. Make it executable (`chmod +x`).

    4. **valid-full** -- All optional fields populated:
       ```json
       {
         "name": "valid-full",
         "version": "3.1.0-beta.1",
         "description": "Test fixture with all optional fields",
         "author": { "name": "Full Author" },
         "homepage": "https://example.com/valid-full",
         "repository": "https://github.com/test/valid-full",
         "license": "MIT",
         "keywords": ["test", "fixture", "full"],
         "commands": ["./commands/example.md"],
         "agents": ["./agents/full-example-agent.md"],
         "hooks": {
           "PostToolUse": [
             {
               "matcher": "Bash",
               "hooks": [
                 {
                   "type": "command",
                   "command": "echo 'post tool use'"
                 }
               ]
             }
           ]
         }
       }
       ```
       Also create:
       - `commands/example.md` with `# Example Command`
       - `agents/full-example-agent.md` with `# Full Example Agent`
       - `hooks/hooks.json` (not referenced in manifest, but exists for directory presence)

    **INVALID FIXTURES (must fail validation with descriptive errors):**

    5. **invalid-no-name** -- Missing required `name` field:
       ```json
       {
         "version": "1.0.0",
         "description": "Plugin missing name"
       }
       ```
       Expected: Schema validation fails. Error mentions `name` as required.

    6. **invalid-bad-version** -- Non-semver version string:
       ```json
       {
         "name": "invalid-bad-version",
         "version": "not-a-version"
       }
       ```
       Expected: Schema validation fails. Error mentions `version` pattern.

    7. **invalid-bad-paths** -- Commands with absolute or non-relative paths:
       ```json
       {
         "name": "invalid-bad-paths",
         "commands": ["/absolute/path.md", "no-dot-slash.md"]
       }
       ```
       Expected: Schema validation fails. Error mentions path pattern.

    8. **invalid-missing-files** -- Commands referencing files that do not exist:
       ```json
       {
         "name": "invalid-missing-files",
         "commands": ["./does-not-exist.md", "./also-missing.md"]
       }
       ```
       Expected: Schema validation passes (paths are valid format), but structural validation fails. Error mentions "File not found" for both paths.

    9. **invalid-extra-fields** -- Unknown top-level fields. NOTE: Per research recommendation, top-level `additionalProperties` is NOT false, so this MAY pass schema validation. The test expectation depends on the schema design from Plan 01. If the schema does not restrict additional properties, this fixture should pass schema validation but the test runner should document this as a known design decision.
       ```json
       {
         "name": "invalid-extra-fields",
         "version": "1.0.0",
         "unknownField": "should this be rejected?",
         "anotherUnknown": 42
       }
       ```
       Expected behavior: This should PASS (not fail) because the schema intentionally allows additional properties for forward compatibility. Include a comment in the test runner explaining this design decision.

    IMPORTANT: For `valid-hooks-only/scripts/setup.sh`, remember to `chmod +x` after creating it.
  </action>
  <verify>
    Verify all fixture directories and files exist:
    ```bash
    ls tests/fixtures/valid-minimal/.claude-plugin/plugin.json
    ls tests/fixtures/valid-commands-only/.claude-plugin/plugin.json
    ls tests/fixtures/valid-commands-only/workflows/example.md
    ls tests/fixtures/valid-hooks-only/.claude-plugin/plugin.json
    ls tests/fixtures/valid-hooks-only/scripts/setup.sh
    test -x tests/fixtures/valid-hooks-only/scripts/setup.sh
    ls tests/fixtures/valid-full/.claude-plugin/plugin.json
    ls tests/fixtures/valid-full/commands/example.md
    ls tests/fixtures/valid-full/agents/full-example-agent.md
    ls tests/fixtures/invalid-no-name/.claude-plugin/plugin.json
    ls tests/fixtures/invalid-bad-version/.claude-plugin/plugin.json
    ls tests/fixtures/invalid-bad-paths/.claude-plugin/plugin.json
    ls tests/fixtures/invalid-missing-files/.claude-plugin/plugin.json
    ls tests/fixtures/invalid-extra-fields/.claude-plugin/plugin.json
    ```
    All 14 files/directories exist. setup.sh is executable.
    (Level 1: Sanity)
  </verify>
  <done>
    All 9 fixture directories created with correct plugin.json content and supporting files. Valid fixtures have all referenced files present. Invalid fixtures have specific, known defects. setup.sh is executable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create test runner and validate all fixtures + real plugins</name>
  <files>scripts/run-fixture-tests.sh</files>
  <action>
    Create `scripts/run-fixture-tests.sh` that runs validate-plugin.sh against all fixtures and both real plugins.

    Script structure:
    ```bash
    #!/usr/bin/env bash
    set -euo pipefail

    SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
    REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
    VALIDATE="$SCRIPT_DIR/validate-plugin.sh"

    passed=0
    failed=0
    errors=()

    # Helper function that runs validation and checks expected exit code
    run_test() {
      local fixture_path="$1"
      local expected_exit="$2"
      local test_name="$3"

      local actual_exit=0
      local output
      output=$("$VALIDATE" "$REPO_ROOT/$fixture_path" 2>&1) || actual_exit=$?

      if [[ "$actual_exit" -eq "$expected_exit" ]]; then
        echo "  PASS: $test_name (exit $actual_exit as expected)"
        ((passed++))
      else
        echo "  FAIL: $test_name (expected exit $expected_exit, got $actual_exit)"
        echo "        Output: $output"
        errors+=("$test_name: expected exit $expected_exit, got $actual_exit")
        ((failed++))
      fi
    }
    ```

    Test cases (call run_test for each):
    ```
    # Valid fixtures (expect exit 0)
    run_test "tests/fixtures/valid-minimal" 0 "valid-minimal"
    run_test "tests/fixtures/valid-commands-only" 0 "valid-commands-only"
    run_test "tests/fixtures/valid-hooks-only" 0 "valid-hooks-only"
    run_test "tests/fixtures/valid-full" 0 "valid-full"

    # Invalid fixtures (expect exit 1)
    run_test "tests/fixtures/invalid-no-name" 1 "invalid-no-name"
    run_test "tests/fixtures/invalid-bad-version" 1 "invalid-bad-version"
    run_test "tests/fixtures/invalid-bad-paths" 1 "invalid-bad-paths"
    run_test "tests/fixtures/invalid-missing-files" 1 "invalid-missing-files"

    # Extra fields fixture -- expect exit 0 (additionalProperties not restricted)
    # Design decision: top-level additionalProperties is allowed for forward compat
    run_test "tests/fixtures/invalid-extra-fields" 0 "extra-fields (pass by design)"

    # Real plugins (expect exit 0)
    run_test "plugins/GRD" 0 "real: GRD"
    run_test "plugins/multi-cli-harness" 0 "real: multi-cli-harness"
    ```

    End of script: Print summary.
    ```
    echo ""
    echo "Results: $passed passed, $failed failed out of $((passed + failed)) tests"
    if [[ $failed -gt 0 ]]; then
      echo "Failures:"
      for err in "${errors[@]}"; do
        echo "  - $err"
      done
      exit 1
    fi
    echo "All tests passed."
    exit 0
    ```

    Make the script executable: `chmod +x scripts/run-fixture-tests.sh`

    Run it: `scripts/run-fixture-tests.sh`

    If any tests fail, diagnose and fix:
    - If a valid fixture fails: fix the fixture (likely a JSON typo or missing file)
    - If an invalid fixture passes: fix the fixture to have the intended defect, or fix the validation script if it has a bug
    - If a real plugin fails: this would indicate a regression in the schema or script -- fix the schema (Plan 01 artifacts), not the plugin

    Iterate until all tests pass.
  </action>
  <verify>
    ```bash
    scripts/run-fixture-tests.sh
    ```
    Exits 0 with output showing:
    - 11 passed, 0 failed
    - All 4 valid fixtures: PASS (exit 0)
    - 4 invalid fixtures: PASS (exit 1 as expected)
    - extra-fields fixture: PASS (exit 0 by design)
    - Both real plugins: PASS (exit 0)
    (Level 1: Sanity)
  </verify>
  <done>
    scripts/run-fixture-tests.sh exists, is executable, runs all 9 fixtures plus both real plugins, and reports 11/11 passing. Phase 1 success criteria are fully met: validate-plugin.sh exits 0 for both real plugins, exits 1 for invalid fixtures with descriptive errors, and schemas cover 100% of fields in both existing plugin.json files.
  </done>
</task>

</tasks>

<verification>
Level 1 (Sanity):
- All 9 fixture directories exist with correct structure
- scripts/run-fixture-tests.sh exits 0 with 11/11 tests passing
- valid fixtures produce exit 0, invalid fixtures produce exit 1
- Real plugins (GRD, multi-cli-harness) still pass

Level 2 (Proxy):
- Error messages for invalid fixtures are specific and actionable:
  - invalid-no-name mentions "name" as required
  - invalid-bad-version mentions version pattern
  - invalid-bad-paths mentions path pattern
  - invalid-missing-files mentions "File not found" with specific file paths
- Multiple errors in a single fixture are all reported (check invalid-missing-files has 2 error lines)
</verification>

<success_criteria>
- 9 fixture directories exist with correct plugin.json files and supporting files
- run-fixture-tests.sh passes with 11/11 tests (4 valid fixtures + 4 invalid fixtures + 1 extra-fields + 2 real plugins)
- Invalid fixtures produce descriptive, actionable error messages
- The full Phase 1 success criteria from ROADMAP.md are met:
  - validate-plugin.sh exits 0 for both real plugins
  - validate-plugin.sh exits 1 for invalid fixtures with descriptive errors
  - Schema covers 100% of fields in both existing plugin.json files
</success_criteria>

<output>
After completion, create `.planning/phases/01-schema-validation/01-03-SUMMARY.md`
</output>
