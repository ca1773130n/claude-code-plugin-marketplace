---
phase: 01-schema-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - schemas/plugin.schema.json
  - schemas/marketplace.schema.json
  - package.json
  - .gitignore
autonomous: true
verification_level: sanity

must_haves:
  truths:
    - "plugin.schema.json validates both plugins/GRD/.claude-plugin/plugin.json and plugins/multi-cli-harness/.claude-plugin/plugin.json with zero errors via ajv-cli"
    - "marketplace.schema.json validates .claude-plugin/marketplace.json with zero errors via ajv-cli"
    - "Schema covers 100% of fields present in both existing plugin.json files (name, version, description, author, commands, hooks)"
    - "ajv-cli is installed and runnable via npx ajv"
  artifacts:
    - path: "schemas/plugin.schema.json"
      provides: "JSON Schema Draft-07 for .claude-plugin/plugin.json"
      contains: "$schema"
    - path: "schemas/marketplace.schema.json"
      provides: "JSON Schema Draft-07 for .claude-plugin/marketplace.json"
      contains: "$schema"
    - path: "package.json"
      provides: "npm project with ajv-cli dev dependency"
      contains: "ajv-cli"
  key_links:
    - from: "schemas/plugin.schema.json"
      to: "plugins/GRD/.claude-plugin/plugin.json"
      via: "ajv validate -s schemas/plugin.schema.json -d plugins/GRD/.claude-plugin/plugin.json exits 0"
    - from: "schemas/plugin.schema.json"
      to: "plugins/multi-cli-harness/.claude-plugin/plugin.json"
      via: "ajv validate -s schemas/plugin.schema.json -d plugins/multi-cli-harness/.claude-plugin/plugin.json exits 0"
    - from: "schemas/marketplace.schema.json"
      to: ".claude-plugin/marketplace.json"
      via: "ajv validate -s schemas/marketplace.schema.json -d .claude-plugin/marketplace.json exits 0"
---

<objective>
Create the JSON Schema files for plugin and marketplace manifests, and set up the npm project with ajv-cli for schema validation.

Purpose: These schemas are the foundation of all validation. Every subsequent plan depends on them existing and correctly modeling the plugin manifest format. The schemas must accommodate both existing plugins (GRD with commands array, multi-cli-harness with inline hooks object) without requiring fields that only one plugin uses.

Output: Two JSON Schema Draft-07 files and a package.json with ajv-cli installed.
</objective>

<context>
@.planning/ROADMAP.md
@.planning/phases/01-schema-validation/01-RESEARCH.md
@plugins/GRD/.claude-plugin/plugin.json
@plugins/multi-cli-harness/.claude-plugin/plugin.json
@.claude-plugin/marketplace.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create plugin.schema.json and marketplace.schema.json</name>
  <files>schemas/plugin.schema.json, schemas/marketplace.schema.json</files>
  <action>
    Create `schemas/` directory and write both JSON Schema Draft-07 files.

    **schemas/plugin.schema.json** must include:

    Required fields:
    - `name`: string, pattern `^[a-z][a-z0-9-]*$`, minLength 1, maxLength 64

    Optional fields (all from the official Claude Code plugin reference):
    - `version`: string, semver pattern `^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(-[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)*)?(\+[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)*)?$`
    - `description`: string, maxLength 500
    - `author`: object with required `name` (string), optional `email` (format: email), optional `url` (format: uri). Use `additionalProperties: false` on author only.
    - `homepage`: string, format uri
    - `repository`: string, format uri
    - `license`: string
    - `keywords`: array of unique strings
    - `commands`: anyOf [relativePath string, array of relativePath strings] -- GRD uses this as array of 36 paths
    - `agents`: anyOf [relativePath string, array of relativePath strings]
    - `skills`: anyOf [relativePath string, array of relativePath strings]
    - `hooks`: anyOf [relativePath string, array of relativePath strings, inline object] -- multi-cli-harness uses inline object with SessionStart key
    - `mcpServers`: anyOf [relativePath string, array of relativePath strings, inline object]
    - `outputStyles`: anyOf [relativePath string, array of relativePath strings]
    - `lspServers`: anyOf [relativePath string, array of relativePath strings, inline object]

    Definitions to create:
    - `relativePath`: string with pattern `^\\.\\/.*` (must start with `./`)
    - `pathOrPaths`: anyOf [relativePath, array of relativePaths with minItems 1]
    - `pathOrPathsOrObject`: anyOf [relativePath, array of relativePaths, object]
    - `authorObject`: object with name required, email/url optional, additionalProperties false

    For the inline hooks object, use `patternProperties` to validate event names:
    Pattern: `^(PreToolUse|PostToolUse|PostToolUseFailure|PermissionRequest|UserPromptSubmit|Notification|Stop|SubagentStart|SubagentStop|SessionStart|SessionEnd|TeammateIdle|TaskCompleted|PreCompact)$`
    Each event maps to an array of hook group objects containing a `hooks` array.
    Do NOT use `additionalProperties: false` at the top level of plugin schema -- the Claude Code spec may add new fields.

    **schemas/marketplace.schema.json** must include:

    Required fields: `name`, `owner`, `plugins`
    - `name`: string, pattern `^[a-z][a-z0-9-]*$`
    - `owner`: object with required `name`, optional `email`, additionalProperties false
    - `plugins`: array of pluginEntry objects, minItems 1

    Each pluginEntry requires: `name`, `source`
    Optional pluginEntry fields: `description`, `version`, `author`, `homepage`, `repository`, `license`, `keywords`, `category`, `tags`, `strict`, `commands`, `agents`, `hooks`, `mcpServers`, `lspServers`

    Source: Research findings in 01-RESEARCH.md, Examples 1 and 2 for full schema structure.

    IMPORTANT pitfalls from research to avoid:
    - Always anchor regex patterns with `^` and `$` (Pitfall 1 from research)
    - Use `anyOf` not `oneOf` for union types (Pitfall 2 from research)
    - Keep relativePath pattern simple: `^\\.\\/.*` -- do not over-restrict path characters (Pitfall 3)
  </action>
  <verify>
    Validate that both schemas are valid JSON:
    ```
    cat schemas/plugin.schema.json | python3 -m json.tool > /dev/null
    cat schemas/marketplace.schema.json | python3 -m json.tool > /dev/null
    ```
    Check that both schemas contain `$schema` key pointing to draft-07.
    Check that plugin schema has all fields present in GRD plugin.json (name, version, description, author, commands) and multi-cli-harness plugin.json (name, version, description, author, hooks).
    (Level 1: Sanity)
  </verify>
  <done>
    Both schema files exist in schemas/, are valid JSON, reference Draft-07, and contain property definitions for every field present in both existing plugin.json files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Set up npm project with ajv-cli and validate schemas against real plugins</name>
  <files>package.json, .gitignore</files>
  <action>
    1. Create `package.json` with:
       - name: "claude-plugin-marketplace"
       - version: "0.1.0"
       - private: true
       - description: "Claude Code plugin marketplace infrastructure"
       - devDependencies: { "ajv-cli": "5.0.0" }
       - scripts section with:
         - "validate:schema": "ajv validate --spec=draft7 --all-errors --errors=text"

    2. Run `npm install` to install ajv-cli.

    3. Update `.gitignore` to include `node_modules/` if not already present. Also add `.planning/` since planning artifacts should not be committed to the plugin marketplace repo (they are development-only). Check if `.gitignore` exists first; if not, create it with `node_modules/`.

    4. Validate both real plugins against plugin.schema.json:
       ```
       npx ajv validate -s schemas/plugin.schema.json -d plugins/GRD/.claude-plugin/plugin.json --spec=draft7 --all-errors --errors=text
       npx ajv validate -s schemas/plugin.schema.json -d plugins/multi-cli-harness/.claude-plugin/plugin.json --spec=draft7 --all-errors --errors=text
       ```

    5. Validate marketplace manifest against marketplace.schema.json:
       ```
       npx ajv validate -s schemas/marketplace.schema.json -d .claude-plugin/marketplace.json --spec=draft7 --all-errors --errors=text
       ```

    6. If any validation fails, fix the schema (NOT the plugin manifests). The plugins are the source of truth. Iterate until all three pass.

    Handle ajv-cli exit codes correctly (from research Pitfall 5):
    - Exit 0 = valid
    - Exit 1 = invalid data (schema needs fixing)
    - Exit 2 = invalid schema itself (fix schema syntax)
  </action>
  <verify>
    All three ajv commands exit 0:
    ```
    npx ajv validate -s schemas/plugin.schema.json -d plugins/GRD/.claude-plugin/plugin.json --spec=draft7 --all-errors && echo "GRD: PASS"
    npx ajv validate -s schemas/plugin.schema.json -d plugins/multi-cli-harness/.claude-plugin/plugin.json --spec=draft7 --all-errors && echo "multi-cli-harness: PASS"
    npx ajv validate -s schemas/marketplace.schema.json -d .claude-plugin/marketplace.json --spec=draft7 --all-errors && echo "marketplace: PASS"
    ```
    (Level 1: Sanity)
  </verify>
  <done>
    package.json exists with ajv-cli@5.0.0 as dev dependency. node_modules/ installed. All three real manifests (GRD plugin.json, multi-cli-harness plugin.json, marketplace.json) validate cleanly against their respective schemas with exit code 0.
  </done>
</task>

</tasks>

<verification>
Level 1 (Sanity):
- Both schema files are valid JSON with `$schema` pointing to Draft-07
- `npx ajv validate` exits 0 for GRD plugin.json against plugin.schema.json
- `npx ajv validate` exits 0 for multi-cli-harness plugin.json against plugin.schema.json
- `npx ajv validate` exits 0 for marketplace.json against marketplace.schema.json
- package.json contains ajv-cli@5.0.0 in devDependencies

Level 2 (Proxy):
- Every field in both real plugin.json files has a corresponding property in plugin.schema.json
- Every field in marketplace.json has a corresponding property in marketplace.schema.json
</verification>

<success_criteria>
- Two schema files exist and are valid JSON Schema Draft-07
- ajv-cli installed and functional
- Both existing plugin manifests pass schema validation with zero errors
- Marketplace manifest passes schema validation with zero errors
- No `additionalProperties: false` at top level of plugin schema
</success_criteria>

<output>
After completion, create `.planning/phases/01-schema-validation/01-01-SUMMARY.md`
</output>
